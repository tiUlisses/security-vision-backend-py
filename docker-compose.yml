services:
  api:
    build:
      context: .
      target: dev
    container_name: securityvision-api
    ports:
      - "8000:8000"
    env_file:
      - env/.env.dev
    environment:
      DB_WAIT: "1"
      RUN_MIGRATIONS: "1"
      # Exemplo (ajuste no seu app, se necessário)
      # S3_ENDPOINT_URL: "http://minio:9000"
      # S3_BUCKET_NAME: "${MINIO_BUCKET:-media-public}"
      # AWS_ACCESS_KEY_ID: "${MINIO_ROOT_USER:-minioadmin}"
      # AWS_SECRET_ACCESS_KEY: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      # AWS_DEFAULT_REGION: "${MINIO_REGION:-us-east-1}"
    volumes:
      - ./:/app
      - media:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      mqtt:
        condition: service_started
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: securityvision-db
    environment:
      POSTGRES_DB: rtls_db
      POSTGRES_USER: rtls
      POSTGRES_PASSWORD: rtls123
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: securityvision-redis
    ports:
      - "6379:6379"
    restart: unless-stopped

  mqtt:
    image: eclipse-mosquitto:2
    container_name: securityvision-mqtt
    ports:
      - "1883:1883"
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
      - ./docker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped

  adminer:
    image: adminer:4
    profiles: ["tools"]
    container_name: securityvision-adminer
    ports:
      - "8080:8080"
    depends_on:
      - db
    restart: unless-stopped

  # --- MinIO (S3) ---
  minio:
    image: minio/minio:latest
    container_name: securityvision-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      MINIO_REGION: "${MINIO_REGION:-us-east-1}"
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console web
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/minio/health/ready >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  # Inicializa bucket e libera acesso anônimo (vale para objetos atuais e futuros)
  minio-init:
    image: minio/mc:latest
    container_name: securityvision-minio-init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin}"
      MINIO_BUCKET: "${MINIO_BUCKET:-media-public}"
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD &&
      mc mb -p local/$$MINIO_BUCKET || true &&
      mc anonymous set download local/$$MINIO_BUCKET &&
      echo 'MinIO bucket pronto: ' $$MINIO_BUCKET
      "
    restart: "no"

volumes:
  pgdata:
  media:
  mosquitto-data:
  mosquitto-log:
  minio-data:
